---
marp: true
author: Alexander Dydychkin
title: Computer and OS architecture
theme: default
paginate: true
math: mathjax
footer: "Star slides [here](https://github.com/GoAlexander/courses)"

---

# Лекция №6: Операционная Система (ОС). Unix. Linux. Введение

---

## Что такое Операционная Система?

Это программная прослойка для управления ресурсами компьютера и запуска прикладных программ пользователя

![bg right:30% 80%](../linux/images/os.png)

---

## Всегда ли нужна ОС?

---

![bg right:100% 85%](images/microcontroller.jpg)

---

![bg right:100% 85%](images/arduino_uno.jpg)

---

![bg right:100% 85%](images/raspberry_pi4.png)

---

![bg right:100% 85%](images/raspberry_pi4_2.jpg)

---

## Понятие ОС

> Операционный системы выполняют две основные функции: предоставляют абстракции пользовательским программам и управляют ресурсами компьютера.

*- Э. Таненбаум, Современные операционные системы*

Одни из важнейших абстракции ОС:
- процессы;
- адресные пространства;
- память и виртуальная память;
- файлы.

---

Важнейшие функции ОС (с точки зрения инженера):
- эффективная утилизация вычислительных ресурсов;
- многозадачность и/или **псевдопараллелизм**;
- разделение полномочий, ролевая модель;
- файловая система;
- предоставления абстракций, упрощающих разработку программ;
- стандартизация доступа к ресурсам *(частный случай пункта выше)*.

... с точки зрения офисного клерка:
- предоставление пользовательского интерфейса (желательно графического (GUI)).

---

## Из чего состоит ОС?

---

ОС состоит из:
* ядра;
* драйверов устройств (драйвер usb-мышки etc);
* сетевой и файловой подсистем (ext4, extfat, ntfs, sysfs, raiserfs etc);
* системные библиотеки (glibc etc);
* оболочка с утилитами: shell (bash, zsh, fish etc) или DE (Gnome, KDE etc).

---

## Unix и Linux

---

## Семейство ОС Unix

> Cемейство переносимых, многозадачных и многопользовательских операционных систем, которые основаны на идеях оригинального проекта AT&T Unix, разработанного в 1970-х годах в исследовательском центре Bell Labs Кеном Томпсоном, Деннисом Ритчи и другими.

Также Ритчи создатель языка С.

---

> Операционные системы семейства Unix характеризуются **модульным дизайном**, в котором каждая задача выполняется **отдельной утилитой**, взаимодействие осуществляется через **единую файловую систему**, а для работы с утилитами используется **командная оболочка**.

---
# Unix-семейство
![bg right:65% 90%](../linux/images/unix_history.png)

---

# Linux is everywhere!

* **Linux** - это ядро, а **GNU/Linux** - это ОС
* Linux и GNU/Linux распространяются по модели open source

*Дополнительное чтение:* [*GNU/Linux*](https://www.gnu.org/gnu/linux-and-gnu.ru.html)

---

## История Linux
![bg right:40% 65%](../linux/images/torvalds.jpg)

Автор **Линус Торвальдс** *(он же написал Git)*.
Август 25, 1991: Анонс в email-рассылке (день рождения Linux)

Во время учебы в университете ему не понравилась учебная ОС MINIX (автор Эндрю Таненбаум), Линус решил сделать свою. Тут и закрутилось.


---

В 1983 Ричард Мэттью Столлман основал проект [GNU](https://en.wikipedia.org/wiki/GNU_Project) с целью создания **свободной** Unix-подобной операционной системы. К началу 1990-ых было готово всё, кроме ядра [GNU Hurd](https://en.wikipedia.org/wiki/GNU_Hurd), сделанного по принципу микроядерной архитектуры.

---
>**1992**: The Linux kernel is relicensed under the **GNU GPL**.

>**1993**: Over 100 developers work on the Linux kernel. With their assistance the kernel is **adapted to the GNU environment**, which creates a large spectrum of application types for Linux. The oldest currently existing Linux distribution, Slackware, is released for the first time. Later in the same year, the Debian project is established. Today it is the largest community distribution.

[History of Linux by Wikipedia](https://en.wikipedia.org/wiki/History_of_Linux)

---

## Что такое Open source?

>**Код открытого программного обеспечения (open source software)** доступен для просмотра, изучения и изменения, что позволяет убедиться в отсутствии уязвимостей и неприемлемых для пользователя функций, принять участие в доработке открытой программы, использовать код для создания новых программ и исправления в них ошибок — через заимствование исходного кода, если это позволяет совместимость лицензий, или через изучение использованных алгоритмов,структур данных и технологий, методик и интерфейсов.

[Wikipedia](https://ru.wikipedia.org/wiki/%D0%9E%D1%82%D0%BA%D1%80%D1%8B%D1%82%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5)

---

## История Open Source
Ричард Мэттью Столлман (RMS) - главный идеолог движения ПО с открытым исходным кодом. Основатель фонда Free Software Foundation (FSF), проекта GNU.

Суть Open Source: **Софт должен быть свободным для чтения, модификации и создания производных работ.**

[Подробнее про RMS](https://ru.wikipedia.org/wiki/%D0%A1%D1%82%D0%BE%D0%BB%D0%BB%D0%BC%D0%B0%D0%BD,_%D0%A0%D0%B8%D1%87%D0%B0%D1%80%D0%B4_%D0%9C%D1%8D%D1%82%D1%82%D1%8C%D1%8E)
[Как мне выбрать лицензию?](https://choosealicense.com)

![bg right:40% 65%](../linux/images/stollman.jpg)

---

## Свободное ПО. Тезисно
* Создана концепция "[сopyleft](https://www.gnu.org/licenses/copyleft.ru.html)", как антипод "copyright"
* Созданы GPL-like лицензии, которые юридически защищают свободное ПО от превращения в проприетарное ПО: *"Вы не вольны быть не свободным" :smile:*
* Созданы более гибкие "[permissive licenses](https://ru.wikipedia.org/wiki/%D0%A0%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D0%BB%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D1%8F_%D1%81%D0%B2%D0%BE%D0%B1%D0%BE%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE_%D0%9F%D0%9E)". Производное ПО может сменить лицензию (пример: лицензия MIT)
* Вводится понятие "совместимость лицензий"
* Вспоминаем курс по праву, не следует путать с авторством, оно не отделимо
* Лицензия ядра Linux: GNU GPL v2

---

![bg right:100% 65%](../linux/images/licensing.png)

---

## GNU/Linux
GNU/Linux - ОС. Ядро + огромное количество утилит вокруг:
* Монолитное ядро Linux
* User space в виде GNU
    * GNU Compiler Collection (gcc)
    * GNU C library
    * [GNU Core Utils](https://ru.wikipedia.org/wiki/GNU_Coreutils), [список](https://en.wikipedia.org/wiki/List_of_GNU_Core_Utilities_commands)
    * [GNU Binutils](https://ru.wikipedia.org/wiki/GNU_Binutils)
    * GNU Debugger
    * GNU shell (командная оболочка)

---

* Загрузчик (имеется ввиду init system). Примеры: systemd, sysinit.
* [Desktop environment](https://wiki.archlinux.org/title/Desktop_environment_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)) (DE)

![bg right:40% 65%](../linux/images/tux.png)

---

## Философия Unix
>«Философия Unix гласит:
Пишите программы, которые делают что-то одно и делают это хорошо.
Пишите программы, которые бы работали вместе.
Пишите программы, которые бы поддерживали текстовые потоки, поскольку это универсальный интерфейс».
Обычно эти высказывания сводятся к одному «Делайте что-то одно, но делайте это хорошо».

---

>1. Красиво — небольшое.
>2. Пусть каждая программа делает что-то одно, но хорошо.
>3. Стройте прототип программы как можно раньше.
>4. Предпочитайте переносимость эффективности.
>5. Храните данные в простых текстовых файлах.
>6. Извлекайте пользу из уже существующих программных решений.
>7. Используйте скриптовые языки для уменьшения трудозатрат и улучшения переносимости.
>8. Избегайте пользовательских интерфейсов, ограничивающих возможности пользователя по взаимодействию с системой.
>9. Делайте каждую программу «фильтром».

[Философия Unix](https://ru.wikipedia.org/wiki/%D0%A4%D0%B8%D0%BB%D0%BE%D1%81%D0%BE%D1%84%D0%B8%D1%8F_Unix)

---

## Too long; didn't read (TLDR)
* Консольный интерфейс для взаимодействия с пользователем
* Текстовые файлы есть добро
* Конкретная программа делает что-то одно, но хорошо
* Архитектура программ должна поощрять их использование с остальной инфраструктурой *nix-систем (частный случай [конвееры](https://habr.com/ru/articles/195152/))
* Скрипты являются удачным решением для автоматизации рутины

---

## Отличия от MS Windows
* Нет одного разработчика (компании), есть сообщество;
* Нет одного DE, загрузчика и т. д. Есть выбор и зоопарк;
* Большое количество дистрибьютивов (aka OS): Ubuntu, RedHat, CentOS, Gentoo, Arch, Suse, Mandriva, TrueNas, Sailfish OS...
* Как правило дистрибьютивы свободны и бесплатны;
* Метод распространения софта посредством пакетов в репозитории;
* Одна точка монтирования файловой системы;
* Акцент на консольный интерфейс и текстовые файлы.

---

## Консольный интерфейс и все есть файл
* Всё есть файл. Да, даже устройства, даже сетевое соединение, даже папка:
    * VirtualFS
    * SysFS - виртуальная файловая система для устройств
    * [Everything is a file](https://en.wikipedia.org/wiki/Everything_is_a_file)
* Консольный интерфейс благодаря своей архитектуре дает максимум свободы для творчества, модульности и автоматизации

---

<!-- PART #7 -->
---

# Лекция №7: Дистрибьютивы. Лицензирование.

---

## Дистрибьютив ("Software Distribution", он же "distro")

> ГОСТ Р 53623-2009. Дистрибьютив
Форма распространения программного обеспечения, обычно содержащая программу-установщик (для выбора режимов и параметров установки) и набор файлов, содержащих отдельные части программного средства.

В понимании Windows-пользователя, дистрибьютив -  это и есть ОС.

**Дистрибьютив** - это набор проинтегрированных и протестированных программ (ядро, загрузчик, установщик, user-space).

---

Существуют семейства и подсемейства дистрибьютивов, к примеру **deb**-based, **rpm**-based и так далее.
Каждый дистрибьютив исповедует свою **политику/философию**: обновлений, среды исполнения, размера, безопасности, UI/UX дизайна и так далее.

> Каждая достаточно большая (и не очень) корпорация имеет свой Linux-дистрибьютив, даже если он ей не нужен. :smile:

---

## Наиболее популярные дистрибьютивы

DEB-based:
- **Debian** - один из самых старых и популярных дистрибьютивов, имеет один из самых больших пакетных репозиториев.
- **Ubuntu** - самый популярный дистрибьютив для пользователей ("десктопный"). В последнее время набирают популярность его embedded и server редакции. Разработчик Canonical.

RPM-based:
- **RHEL** - самый популярный серверный дистрибьютив, платный. Разработчик Red Hat (куплена IBM).
- **Fedora** - десктопная редакция от Red Hat. Бесплатно.
- **CentOS** - "бесплатный Red Hat", один из самых популярных бесплатных серверных дистрибьютивов.

---

Другие:
- **Gentoo** - для установки дистрибьютива пользователь должен скомпилировать все приложения ("скомпилировать мир"). Таким образом увеличивается скорость исполнения и минимализм программ. Является основой для Chrome OS.
- **Arch** - для установки дистрибьютива пользователь должен произвести тонкую настройку посредством текстовых конфигов. Является основой для SteamOS 3.0+.
- **Alpine** - крайне минималистичный дистрибьютив (в докер-образе занимает ~15 МБ). Является основой для PostmarketOS. Крайне часто используется в docker-образах.

---

Другие №2:
- **Android / AOSP**
- **Sailfish OS / Aurora OS**
- **Ubuntu Touch**
- **Tizen OS**
- **Web OS**
- **EulerOS**
- **Clear Linux**
- **OpenWrt**
- **FreeNAS** / **TrueNAS** (BSD)
- **OpenMediaVault**

---

### Классификации дистрибьютивов

- назначение (десктопные, серверные, реального времени, мобильные)
- пакетный менеджер
- политика / система обновлений дистрибьютивов
- создатель / поддерживающая организация
- интерфейс взаимодействия с пользователем
- место в иерархии дистрибьютивов (дочерний, родительский, самобытный)

---

## Лицензирование. Самое важное. Или как не потерять работу.

---

### Что такое лицензия?

---

Правовой инструмент, определяющий использование и распространение программного обеспечения, защищённого авторским правом.

По сути, лицензия выступает гарантией того, что издатель ПО, которому принадлежат исключительные права на программу, не подаст в суд на того, кто ею пользуется.

---

### А какие бывают лицензии?

- Proprietary license (or closed-source license)
- Open source license

---

### Что такое open source?

- User should control program not program the user!
- Свобода != бесплатность (free software)

GNU GPL:

0. Программу можно свободно использовать с любой целью.
1. Можно изучать, как программа работает, и адаптировать её для своих целей. Условием этого является доступность исходного текста программы.
2. Можно свободно распространять копии программы — в помощь товарищу.
3. Программу можно свободно улучшать и публиковать свою улучшенную версию — с тем, чтобы принести пользу всему сообществу.

---

### Можно ли использовать open source code в production?

- Можно, но не любой и с соблюдением условий!
- Не все таких же взглядов как Столлман, поэтому...

---

![bg right:100% 95%](./images/licensing1.png)

---

![bg right:100% 95%](./images/licensing2.png)

---

### Так как использовать Open Source код в proprietary продукте?

- **НЕ ИСПОЛЬЗОВАТЬ СТОРОННИЙ КОД!**
    - (пишем свой аналог или творчески переписываем)
- **НЕ линкуемся статически с open source проектами**

- Проверяем под какой лицензией автор опубликовал свой код
- Используя новую зависимость, читаем ее лицензию
- Делать сканы по базам данных открытого кода

---

![bg right:100% 95%](./images/licensing3.png)

---

![bg right:100% 95%](./images/licensing4.png)

---

### tldr. Чему научились?

- Фактически есть два множество ПО: proprietary и open source
- Есть open source ПО (permissive licensing), которые могут «превратиться» в closed source
- Есть «вирусные лицензии»
- Можем отличить «хорошую» лицензию от «плохой»
- **Как не обGPL`иться!**

---

### Полезные ссылки

- https://en.wikipedia.org/wiki/Software_license
о лицензиях кратко и доходчиво
- https://choosealicense.com/licenses/
- https://choosealicense.com/appendix/
список самых популярных open source лицензий
- https://tldrlegal.com/licenses/browse
еще больший список лицензий
- https://www.youtube.com/watch?v=Ag1AKIl_2GM
Free software, free society: Richard Stallman at TEDxGeneva 2014

---

<!-- PART #8 -->
---

# Лекция №8: Архитектура современных ОС на примере Linux. VFS, как общее звено ОС.

---

{lecture placeholder...}

---

{seminar placeholder...}

---


<!-- PART #9-->
---

# Лекция №9: Механизмы межпроцесного взаимодействия. Файловая система.
Система безопасности (пользователи/группы, права доступа). System space (root). User space.

---

{lecture placeholder...}

---


<!-- PART #10-->
---

# Лекция №10: Системные вызовы (syscalls). Механизм управления памятью.

---

Что такое интерфейс?

---

Что такое API? Зачем мы им пользуемся?

---

Что такое ядро ОС? Чем оно занимается?

---

Уровни Linux

![bg right:75% 95%](./images/tannebaum/5.jpg)

---

Структура ядра Linux

![bg right:75% 95%](./images/tannebaum/4.jpg)

---

Интерфейс для взаимодействия с (ядром) ОС называется **системными вызовами (syscalls)**.

- Интерфейсы различаются от ОС к ОС (и от версий ОС).
- Существуют стандарты, специфицирующие интерфейс, к примеру **POSIX**
- **В Linux системные вызовы представлены на C/C++.**

---

`pid` - id процесса
`fd` - file descriptor
`n` - кол-во байт
`position` - смещение внутри файла
`seconds` - прощедшее время

![bg right:60% 85%](./images/tannebaum/1.jpg)

*Актуальные версии ядра Linux имеют несколько сотен системных вызовов.*

---

Работа системного вызова `read` на примере

```C++
count = read(fd, buffer, nbytes)
```

⚠️ Обычно используются обертки над системными вызовами (к примеру open() and read()). Системные вызовы доступны посредством `#include <sys/syscall.h>` и вызова `syscall()`. [Документация](https://man7.org/linux/man-pages/man2/syscall.2.html).

---

![bg right:100% 75%](./images/tannebaum/2.jpg)

---

⚠️ Любой однопоточный компьютер может выполнить только 1 команду одномоментно. Когда пользовательскому процессу нужна какая-либо услуга от ОС (ядра). Он должен выполнить **системное прерывание**, чтобы передать управление ОС. ОС обрабатывает вызов и возвращает управление в пользовательское пространство.
1) Системный вызов исполняется в пространстве ядра
2) "Переключение" необходимо
3) "Переключение" дорого по ресурсам. Если есть возможность оставаться в пространстве пользователя (не переключать контекст) - нужно оставаться.

---

### Системные вызовы для управления процессами

`fork` - создание (создание точной копии) нового процесса

![bg right:40% 65%](images/tannebaum/process_memory.jpg)

---

### Win API

В Linux есть практическая однозначная связь между вызовом библиотечной функции `read` и системного вызова `read`. В Windows ситуация совершенно иная. 

Win API - blackbox. Вызов конкретной функции из Win API не обязательно приведет к использованию системного вызова. У Win API тысячи вызовов.

---

![bg right:100% 75%](./images/tannebaum/3.jpg)

---

### Особенности процесса в Linux (повторение)

- Работающие и фоновые процессы (демоны)
- Процесс создается методом создания точной копии
- Родительский процесс и дочерний процесс
- Lazy copy и приватные образы памяти
- PID
- Общение между процессами только с помощью конвееров (pipes) и сигналов (signals: SIGKILL, SIGTERM...).

---

![bg right:100% 75%](./images/tannebaum/6.jpg)

---

<!-- PART #11-->
---

# Лекция №11: Многопоток, механизм синхронизации.

{placeholder...}

---

<!-- PART #12-->
---

# Лекция №12: Типы ядер. ОС реального времени.

{placeholder...}

---

# До встречи!
